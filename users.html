<!DOCTYPE html>
<html lang="th">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>จัดการบุคลากร - Hospital Shift Management System</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Animate.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<!-- Hover.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hover.css/2.3.1/css/hover-min.css">
<!-- Custom CSS -->
<style>
:root {
--primary-gradient: linear-gradient(120deg, #7269ef, #4776e6);
--secondary-gradient: linear-gradient(120deg, #00c6ff, #0072ff);
--success-gradient: linear-gradient(120deg, #05c075, #01a75a);
--danger-gradient: linear-gradient(120deg, #ff6b6b, #ee0979);
--warning-gradient: linear-gradient(120deg, #f7b733, #fc4a1a);
--info-gradient: linear-gradient(120deg, #0093e9, #80d0c7);
--sidebar-color: #2b343b;
--dark-glass: rgba(0, 0, 0, 0.5);
--light-glass: rgba(255, 255, 255, 0.1);
--shadow-glass: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
--neon-accent: 0 0 10px rgba(0, 123, 255, 0.7);
}

body {
font-family: 'Prompt', sans-serif;
background: #f0f2f5;
margin: 0;
padding: 0;
overflow-x: hidden;
}

/* Sidebar */
.sidebar {
background: var(--sidebar-color);
color: white;
height: 100vh;
position: fixed;
transition: all 0.3s;
width: 280px;
z-index: 1040;
overflow-y: auto;
box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
}

.sidebar-brand {
padding: 20px;
text-align: center;
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.sidebar-brand h2 {
color: white;
margin: 0;
font-weight: 700;
font-size: 24px;
}

.sidebar-brand span {
color: #4776e6;
}

.sidebar-menu {
padding: 20px 0;
}

.sidebar-menu .menu-header {
padding: 10px 25px;
font-size: 12px;
text-transform: uppercase;
color: #6c757d;
font-weight: 600;
}

.sidebar-menu ul {
list-style: none;
padding: 0;
}

.sidebar-menu li {
margin-bottom: 5px;
}

.sidebar-menu a {
color: rgba(255, 255, 255, 0.7);
display: flex;
align-items: center;
padding: 12px 25px;
text-decoration: none;
transition: all 0.3s;
border-left: 4px solid transparent;
}

.sidebar-menu a:hover,
.sidebar-menu a.active {
color: white;
background: rgba(255, 255, 255, 0.1);
border-left: 4px solid #4776e6;
}

.sidebar-menu a i {
margin-right: 10px;
font-size: 18px;
width: 25px;
text-align: center;
}

.sidebar-menu .badge {
margin-left: auto;
}

/* Main Content */
.main-content {
margin-left: 280px;
padding: 20px;
transition: all 0.3s;
}

/* Top Navbar */
.top-navbar {
background: white;
border-radius: 15px;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
padding: 15px 20px;
margin-bottom: 25px;
display: flex;
justify-content: space-between;
align-items: center;
}

.top-navbar .page-title {
font-size: 24px;
font-weight: 600;
margin: 0;
background: var(--primary-gradient);
-webkit-background-clip: text;
background-clip: text;
color: transparent;
}

/* Search & Filter Bar */
.search-filter-bar {
background: white;
border-radius: 15px;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
padding: 15px 20px;
margin-bottom: 25px;
}

.custom-select {
border-radius: 10px;
border: 1px solid #dee2e6;
padding: 8px 12px;
width: 100%;
font-size: 14px;
}

.custom-select:focus {
border-color: #4776e6;
box-shadow: 0 0 0 0.2rem rgba(71, 118, 230, 0.25);
outline: none;
}

.search-input {
border-radius: 10px;
border: 1px solid #dee2e6;
padding: 8px 15px;
width: 100%;
font-size: 14px;
}

.search-input:focus {
border-color: #4776e6;
box-shadow: 0 0 0 0.2rem rgba(71, 118, 230, 0.25);
outline: none;
}

/* Card Styles */
.content-card {
background: white;
border-radius: 15px;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
padding: 20px;
margin-bottom: 25px;
}

.content-card .card-title {
font-size: 18px;
font-weight: 600;
margin-bottom: 20px;
color: #333;
display: flex;
justify-content: space-between;
align-items: center;
}

/* Table Styles */
.custom-table {
width: 100%;
border-collapse: separate;
border-spacing: 0;
}

.custom-table th {
background: #f8f9fa;
padding: 12px 15px;
font-weight: 600;
color: #495057;
border-bottom: 2px solid #dee2e6;
text-align: left;
}

.custom-table td {
padding: 12px 15px;
border-bottom: 1px solid #dee2e6;
vertical-align: middle;
}

.custom-table tr:last-child td {
border-bottom: none;
}

.custom-table tr:hover td {
background: #f8f9fa;
}

/* Status Badges */
.status-badge {
padding: 5px 10px;
border-radius: 30px;
font-size: 12px;
font-weight: 500;
}

.status-badge.active {
background-color: #d4edda;
color: #155724;
}

.status-badge.inactive {
background-color: #f8d7da;
color: #721c24;
}

/* Role Badges */
.role-badge {
padding: 5px 10px;
border-radius: 30px;
font-size: 12px;
font-weight: 500;
}

.role-badge.doctor {
background-color: #cce5ff;
color: #004085;
}

.role-badge.nurse {
background-color: #d1ecf1;
color: #0c5460;
}

.role-badge.admin {
background-color: #e2e3e5;
color: #383d41;
}

/* Custom Button */
.btn-custom {
border-radius: 10px;
padding: 8px 15px;
font-size: 14px;
font-weight: 500;
transition: all 0.3s;
}

.btn-custom-primary {
background: var(--primary-gradient);
border: none;
color: white;
}

.btn-custom-primary:hover {
box-shadow: 0 5px 15px rgba(71, 118, 230, 0.3);
transform: translateY(-2px);
}

/* Action Buttons */
.action-btn {
width: 32px;
height: 32px;
border-radius: 8px;
display: inline-flex;
align-items: center;
justify-content: center;
margin-right: 5px;
transition: all 0.3s;
}

.action-btn:hover {
transform: translateY(-2px);
}

.action-btn-edit {
background-color: #e7f3ff;
color: #0d6efd;
}

.action-btn-delete {
background-color: #ffe7e7;
color: #dc3545;
}

.action-btn-view {
background-color: #e7fff3;
color: #198754;
}

/* Modal Styles */
.custom-modal .modal-content {
border-radius: 15px;
border: none;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.custom-modal .modal-header {
background: var(--primary-gradient);
border-top-left-radius: 15px;
border-top-right-radius: 15px;
color: white;
border-bottom: none;
}

.custom-modal .modal-title {
font-weight: 600;
}

.custom-modal .modal-footer {
border-top: none;
padding: 15px 20px;
}

.custom-modal .form-label {
font-weight: 500;
color: #495057;
}

.custom-modal .form-control,
.custom-modal .form-select {
border-radius: 10px;
padding: 10px 15px;
border: 1px solid #dee2e6;
}

.custom-modal .form-control:focus,
.custom-modal .form-select:focus {
border-color: #4776e6;
box-shadow: 0 0 0 0.2rem rgba(71, 118, 230, 0.25);
}

/* User Cards */
.user-cards-container {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
gap: 20px;
}

.user-card {
background: white;
border-radius: 15px;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
overflow: hidden;
transition: all 0.3s;
}

.user-card:hover {
transform: translateY(-5px);
box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
}

.user-card-header {
padding: 20px;
background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
position: relative;
}

.user-card-avatar {
width: 80px;
height: 80px;
border-radius: 50%;
margin: 0 auto 15px;
display: flex;
align-items: center;
justify-content: center;
font-size: 36px;
color: white;
background: var(--primary-gradient);
}

.user-card-name {
font-size: 18px;
font-weight: 600;
text-align: center;
margin-bottom: 5px;
}

.user-card-role {
text-align: center;
margin-bottom: 10px;
}

.user-card-body {
padding: 20px;
}

.user-card-info {
margin-bottom: 15px;
}

.user-card-info-row {
display: flex;
margin-bottom: 8px;
}

.user-card-info-label {
width: 100px;
font-weight: 500;
color: #6c757d;
}

.user-card-info-value {
flex: 1;
}

.user-card-actions {
display: flex;
justify-content: center;
gap: 10px;
margin-top: 15px;
}

/* Loading Spinner */
.loading-spinner {
width: 40px;
height: 40px;
border: 4px solid rgba(0, 0, 0, 0.1);
border-radius: 50%;
border-top: 4px solid #4776e6;
animation: spin 1s linear infinite;
margin: 20px auto;
}

@keyframes spin {
0% {
transform: rotate(0deg);
}
100% {
transform: rotate(360deg);
}
}

/* Tab Styles */
.user-tabs {
margin-bottom: 20px;
}

.user-tabs .nav-link {
color: #495057;
font-weight: 500;
padding: 12px 20px;
border-radius: 10px;
margin-right: 10px;
transition: all 0.3s;
}

.user-tabs .nav-link.active {
background: var(--primary-gradient);
color: white;
box-shadow: 0 5px 15px rgba(71, 118, 230, 0.3);
}

/* Float Button */
.btn-float {
position: fixed;
bottom: 30px;
right: 30px;
width: 60px;
height: 60px;
border-radius: 50%;
text-align: center;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
display: flex;
align-items: center;
justify-content: center;
font-size: 24px;
z-index: 1030;
transition: all 0.3s;
}

.btn-float:hover {
transform: scale(1.1);
box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

/* Empty State */
.empty-state {
padding: 40px 20px;
text-align: center;
color: #6c757d;
}

.empty-state-icon {
font-size: 60px;
margin-bottom: 20px;
opacity: 0.3;
}

.empty-state-message {
font-size: 18px;
margin-bottom: 10px;
}

.empty-state-submessage {
font-size: 14px;
opacity: 0.7;
margin-bottom: 20px;
}

/* Responsive Media Queries */
@media (max-width: 992px) {
.sidebar {
width: 80px;
overflow: visible;
}

.sidebar-brand h2 span {
display: none;
}

.sidebar-menu a span {
display: none;
}

.sidebar-menu a i {
margin-right: 0;
font-size: 22px;
}

.main-content {
margin-left: 80px;
}

.user-cards-container {
grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
}
}

@media (max-width: 768px) {
.search-filter-bar {
padding: 15px;
}

.top-navbar {
flex-direction: column;
align-items: flex-start;
}

.top-navbar .page-title {
margin-bottom: 10px;
}

.user-tabs .nav-link {
padding: 10px 15px;
font-size: 14px;
}

.user-card-actions {
flex-direction: column;
}

.user-card-actions .btn {
width: 100%;
margin-bottom: 5px;
}
}
</style>
</head>

<body>
<!-- Sidebar -->
<div class="sidebar">
<div class="sidebar-brand">
<h2 class="animate__animated animate__fadeIn"><i class="fas fa-hospital-user"></i> <span>HSMS</span></h2>
</div>
<div class="sidebar-menu">
<div class="menu-header">เมนูหลัก</div>
<ul>
<li>
    <a href="dashboard.html" class="hvr-sweep-to-right">
        <i class="fas fa-chart-line"></i>
        <span>Dashboard</span>
    </a>
</li>
<li>
    <a href="shift-management.html" class="hvr-sweep-to-right">
        <i class="fas fa-calendar-alt"></i>
        <span>จัดการเวร</span>
    </a>
</li>
<li>
    <a href="overtime.html" class="hvr-sweep-to-right">
        <i class="fas fa-clock"></i>
        <span>คำนวณ OT</span>
    </a>
</li>
<li>
    <a href="shift-requests.html" class="hvr-sweep-to-right">
        <i class="fas fa-exchange-alt"></i>
        <span>คำขอเปลี่ยนเวร</span>
        <span class="badge bg-danger rounded-pill" id="pendingRequestsCount">0</span>
    </a>
</li>
</ul>
<div class="menu-header">ข้อมูลทั่วไป</div>
<ul>
<li>
    <a href="users.html" class="active hvr-sweep-to-right">
        <i class="fas fa-user-md"></i>
        <span>บุคลากร</span>
    </a>
</li>
<li>
    <a href="departments.html" class="hvr-sweep-to-right">
        <i class="fas fa-hospital"></i>
        <span>แผนก</span>
    </a>
</li>
</ul>
<div class="menu-header">รายงาน</div>
<ul>
<li>
    <a href="report-monthly.html" class="hvr-sweep-to-right">
        <i class="fas fa-chart-pie"></i>
        <span>รายงานประจำเดือน</span>
    </a>
</li>
<li>
    <a href="report-yearly.html" class="hvr-sweep-to-right">
        <i class="fas fa-chart-bar"></i>
        <span>รายงานประจำปี</span>
    </a>
</li>
</ul>
</div>
</div>

<!-- Main Content -->
<div class="main-content">
<!-- Top Navbar -->
<div class="top-navbar">
<h3 class="page-title animate__animated animate__fadeIn">จัดการบุคลากร</h3>
<div class="d-flex align-items-center">
<button class="btn btn-custom btn-custom-primary" onclick="openAddUserModal()">
    <i class="fas fa-plus me-2"></i> เพิ่มบุคลากรใหม่
</button>
</div>
</div>

<!-- Search and Filter Bar -->
<div class="search-filter-bar animate__animated animate__fadeInUp">
<div class="row g-3">
<div class="col-md-4">
    <input type="text" class="search-input" id="searchInput" placeholder="ค้นหาชื่อบุคลากร..." onkeyup="filterUsers()">
</div>
<div class="col-md-4">
    <select class="custom-select" id="departmentFilter" onchange="filterUsers()">
        <option value="">ทุกแผนก</option>
        <!-- แผนกจะถูกโหลดด้วย JavaScript -->
    </select>
</div>
<div class="col-md-4">
    <select class="custom-select" id="roleFilter" onchange="filterUsers()">
        <option value="">ทุกตำแหน่ง</option>
        <option value="Doctor">แพทย์</option>
        <option value="Nurse">พยาบาล</option>
        <option value="Admin">ผู้ดูแลระบบ</option>
    </select>
</div>
</div>
</div>

<!-- User Tabs -->
<ul class="nav nav-pills user-tabs animate__animated animate__fadeInUp" style="animation-delay: 0.1s;" id="userDisplayTabs" role="tablist">
<li class="nav-item" role="presentation">
<button class="nav-link active" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-view" type="button" role="tab" aria-controls="table-view" aria-selected="true">
    <i class="fas fa-table me-2"></i> แบบตาราง
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="cards-tab" data-bs-toggle="tab" data-bs-target="#cards-view" type="button" role="tab" aria-controls="cards-view" aria-selected="false">
    <i class="fas fa-id-card me-2"></i> แบบการ์ด
</button>
</li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="userDisplayTabContent">
<!-- Table View Tab -->
<div class="tab-pane fade show active" id="table-view" role="tabpanel" aria-labelledby="table-tab">
<div class="content-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
    <div class="table-responsive">
        <table class="custom-table" id="usersTable">
            <thead>
                <tr>
                    <th>ชื่อ</th>
                    <th>อีเมล</th>
                    <th>ตำแหน่ง</th>
                    <th>แผนก</th>
                    <th>สถานะ</th>
                    <th>การดำเนินการ</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <!-- ข้อมูลจะถูกโหลดด้วย JavaScript -->
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="loading-spinner"></div>
                        <p>กำลังโหลดข้อมูล...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
</div>

<!-- Cards View Tab -->
<div class="tab-pane fade" id="cards-view" role="tabpanel" aria-labelledby="cards-tab">
<div class="user-cards-container animate__animated animate__fadeInUp" style="animation-delay: 0.2s;" id="userCardsContainer">
    <!-- ข้อมูลจะถูกโหลดด้วย JavaScript -->
    <div class="loading-container text-center py-5 w-100">
        <div class="loading-spinner"></div>
        <p class="mt-3">กำลังโหลดข้อมูล...</p>
    </div>
</div>
</div>
</div>

<!-- Add/Edit User Modal -->
<div class="modal fade custom-modal" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
    <h5 class="modal-title" id="userModalLabel">เพิ่มบุคลากรใหม่</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
    <form id="userForm">
        <input type="hidden" id="userId">
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="userName" class="form-label">ชื่อ-นามสกุล</label>
                <input type="text" class="form-control" id="userName" required>
            </div>
            <div class="col-md-6">
                <label for="userEmail" class="form-label">อีเมล</label>
                <input type="email" class="form-control" id="userEmail" required>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="userPassword" class="form-label">รหัสผ่าน</label>
                <input type="password" class="form-control" id="userPassword">
                <small class="text-muted" id="passwordHelpText">เว้นว่างไว้หากไม่ต้องการเปลี่ยนรหัสผ่าน</small>
            </div>
            <div class="col-md-6">
                <label for="userRole" class="form-label">ตำแหน่ง</label>
                <select class="form-select" id="userRole" required>
                    <option value="">เลือกตำแหน่ง</option>
                    <option value="Doctor">แพทย์</option>
                    <option value="Nurse">พยาบาล</option>
                    <option value="Admin">ผู้ดูแลระบบ</option>
                </select>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="userDepartment" class="form-label">แผนก</label>
                <select class="form-select" id="userDepartment">
                    <option value="">เลือกแผนก</option>
                    <!-- แผนกจะถูกโหลดด้วย JavaScript -->
                </select>
            </div>
            <div class="col-md-6">
                <label for="userStatus" class="form-label">สถานะ</label>
                <select class="form-select" id="userStatus" required>
                    <option value="1">ใช้งาน</option>
                    <option value="0">ปิดใช้งาน</option>
                </select>
            </div>
        </div>
    </form>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
    <button type="button" class="btn btn-primary" id="saveUserBtn">บันทึก</button>
</div>
</div>
</div>
</div>

<!-- Delete User Modal -->
<div class="modal fade custom-modal" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
    <h5 class="modal-title" id="deleteUserModalLabel">ยืนยันการลบบุคลากร</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
    <input type="hidden" id="deleteUserId">
    <p>คุณแน่ใจหรือไม่ว่าต้องการลบบุคลากรคนนี้?</p>
    <p>การกระทำนี้ไม่สามารถเรียกคืนได้</p>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">ลบ</button>
</div>
</div>
</div>
</div>

<!-- View User Modal -->
<div class="modal fade custom-modal" id="viewUserModal" tabindex="-1" aria-labelledby="viewUserModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
    <h5 class="modal-title" id="viewUserModalLabel">ข้อมูลบุคลากร</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
    <div class="row mb-2">
        <div class="col-5 fw-bold">ชื่อ-นามสกุล:</div>
        <div class="col-7" id="viewUserName"></div>
    </div>
    <div class="row mb-2">
        <div class="col-5 fw-bold">อีเมล:</div>
        <div class="col-7" id="viewUserEmail"></div>
    </div>
    <div class="row mb-2">
        <div class="col-5 fw-bold">ตำแหน่ง:</div>
        <div class="col-7" id="viewUserRole"></div>
    </div>
    <div class="row mb-2">
        <div class="col-5 fw-bold">แผนก:</div>
        <div class="col-7" id="viewUserDepartment"></div>
    </div>
    <div class="row mb-2">
        <div class="col-5 fw-bold">สถานะ:</div>
        <div class="col-7" id="viewUserStatus"></div>
    </div>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
    <button type="button" class="btn btn-primary" onclick="openEditUserModal(document.getElementById('viewUserId').value)">แก้ไข</button>
    <input type="hidden" id="viewUserId">
</div>
</div>
</div>
</div>

<!-- Float Button -->
<button class="btn btn-float bg-primary text-white" onclick="openAddUserModal()">
<i class="fas fa-plus"></i>
</button>

<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Custom JS -->
<script>
// ตัวแปรสำหรับเก็บข้อมูล
const API_BASE_URL = 'http://localhost:3000';
let usersData = [];
let departmentsData = [];
let userModal;
let deleteUserModal;
let viewUserModal;

// เมื่อโหลดหน้าเว็บเสร็จ
document.addEventListener('DOMContentLoaded', function() {
// สร้าง Modal objects
userModal = new bootstrap.Modal(document.getElementById('userModal'));
deleteUserModal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
viewUserModal = new bootstrap.Modal(document.getElementById('viewUserModal'));

// เพิ่ม event listeners
document.getElementById('saveUserBtn').addEventListener('click', saveUser);
document.getElementById('confirmDeleteBtn').addEventListener('click', deleteUser);

// โหลดข้อมูลตั้งต้น
loadDepartments();
loadUsers();
updatePendingRequestsCount();
});

// โหลดข้อมูลแผนก
async function loadDepartments() {
try {
const response = await fetch(`${API_BASE_URL}/getDepartments`);
if (!response.ok) throw new Error('ไม่สามารถโหลดข้อมูลแผนกได้');

departmentsData = await response.json();

// เพิ่มตัวเลือกแผนกลงใน dropdown ของตัวกรอง
const departmentFilter = document.getElementById('departmentFilter');

// เพิ่มตัวเลือกแผนกลงใน dropdown ของฟอร์ม
const userDepartment = document.getElementById('userDepartment');

departmentsData.forEach(dept => {
    // สำหรับตัวกรอง
    const filterOption = document.createElement('option');
    filterOption.value = dept.dept_id;
    filterOption.textContent = dept.dept_name;
    departmentFilter.appendChild(filterOption);
    
    // สำหรับฟอร์ม
    const formOption = document.createElement('option');
    formOption.value = dept.dept_id;
    formOption.textContent = dept.dept_name;
    userDepartment.appendChild(formOption);
});
} catch (error) {
console.error('เกิดข้อผิดพลาดในการโหลดข้อมูลแผนก:', error);
alert('ไม่สามารถโหลดข้อมูลแผนกได้ กรุณาลองใหม่อีกครั้ง');
}
}

// โหลดข้อมูลบุคลากร
async function loadUsers() {
try {
// แสดง loading
document.getElementById('usersTableBody').innerHTML = `
    <tr>
        <td colspan="6" class="text-center">
            <div class="loading-spinner"></div>
            <p>กำลังโหลดข้อมูล...</p>
        </td>
    </tr>
`;

document.getElementById('userCardsContainer').innerHTML = `
    <div class="loading-container text-center py-5 w-100">
        <div class="loading-spinner"></div>
        <p class="mt-3">กำลังโหลดข้อมูล...</p>
    </div>
`;

// เรียก API เพื่อดึงข้อมูลบุคลากร
const response = await fetch(`${API_BASE_URL}/getUsers`);
if (!response.ok) throw new Error('ไม่สามารถโหลดข้อมูลบุคลากรได้');

usersData = await response.json();

// แสดงข้อมูลบุคลากร
displayUsersTable(usersData);
displayUsersCards(usersData);
} catch (error) {
console.error('เกิดข้อผิดพลาดในการโหลดข้อมูลบุคลากร:', error);

document.getElementById('usersTableBody').innerHTML = `
    <tr>
        <td colspan="6" class="text-center text-danger">
            <i class="fas fa-exclamation-circle me-2"></i> ไม่สามารถโหลดข้อมูลบุคลากรได้ กรุณาลองใหม่อีกครั้ง
        </td>
    </tr>
`;

document.getElementById('userCardsContainer').innerHTML = `
    <div class="empty-state w-100">
        <div class="empty-state-icon">
            <i class="fas fa-exclamation-circle"></i>
        </div>
        <div class="empty-state-message">ไม่สามารถโหลดข้อมูลบุคลากรได้</div>
        <div class="empty-state-submessage">โปรดลองใหม่อีกครั้งหรือติดต่อผู้ดูแลระบบ</div>
        <button class="btn btn-primary" onclick="loadUsers()">ลองใหม่</button>
    </div>
`;
}
}

// แสดงข้อมูลบุคลากรในตาราง
function displayUsersTable(users) {
const tbody = document.getElementById('usersTableBody');

if (users.length === 0) {
tbody.innerHTML = `
    <tr>
        <td colspan="6" class="text-center">
            <i class="fas fa-info-circle me-2"></i> ไม่พบข้อมูลบุคลากร
        </td>
    </tr>
`;
return;
}

tbody.innerHTML = '';

users.forEach(user => {
const tr = document.createElement('tr');

// แปลงตำแหน่งและสถานะเป็น badge
let roleBadge;
if (user.role === 'Doctor') {
    roleBadge = '<span class="role-badge doctor">แพทย์</span>';
} else if (user.role === 'Nurse') {
    roleBadge = '<span class="role-badge nurse">พยาบาล</span>';
} else if (user.role === 'Admin') {
    roleBadge = '<span class="role-badge admin">ผู้ดูแลระบบ</span>';
} else {
    roleBadge = '<span class="role-badge">ไม่ระบุ</span>';
}

const statusBadge = user.status ? 
    '<span class="status-badge active">ใช้งาน</span>' : 
    '<span class="status-badge inactive">ปิดใช้งาน</span>';

// หาชื่อแผนก
const department = departmentsData.find(dept => dept.dept_id == user.dept_id);
const deptName = department ? department.dept_name : '-';

tr.innerHTML = `
    <td>${user.name}</td>
    <td>${user.email}</td>
    <td>${roleBadge}</td>
    <td>${deptName}</td>
    <td>${statusBadge}</td>
    <td>
        <button class="btn action-btn action-btn-view" onclick="viewUser(${user.user_id})">
            <i class="fas fa-eye"></i>
        </button>
        <button class="btn action-btn action-btn-edit" onclick="openEditUserModal(${user.user_id})">
            <i class="fas fa-edit"></i>
        </button>
        <button class="btn action-btn action-btn-delete" onclick="confirmDeleteUser(${user.user_id})">
            <i class="fas fa-trash"></i>
        </button>
    </td>
`;

tbody.appendChild(tr);
});
}

// แสดงข้อมูลบุคลากรในรูปแบบการ์ด
function displayUsersCards(users) {
const container = document.getElementById('userCardsContainer');

if (users.length === 0) {
container.innerHTML = `
    <div class="empty-state w-100">
        <div class="empty-state-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="empty-state-message">ไม่พบข้อมูลบุคลากร</div>
    </div>
`;
return;
}

container.innerHTML = '';

users.forEach(user => {
// หาชื่อแผนก
const department = departmentsData.find(dept => dept.dept_id == user.dept_id);
const deptName = department ? department.dept_name : '-';

// แปลงตำแหน่งและสถานะเป็นภาษาไทย
let roleThai = 'ไม่ระบุ';
let roleClass = '';

if (user.role === 'Doctor') {
    roleThai = 'แพทย์';
    roleClass = 'doctor';
} else if (user.role === 'Nurse') {
    roleThai = 'พยาบาล';
    roleClass = 'nurse';
} else if (user.role === 'Admin') {
    roleThai = 'ผู้ดูแลระบบ';
    roleClass = 'admin';
}

const statusThai = user.status ? 'ใช้งาน' : 'ปิดใช้งาน';
const statusClass = user.status ? 'active' : 'inactive';

// อักษรย่อชื่อ
const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();

// สร้างการ์ด
const card = document.createElement('div');
card.className = 'user-card animate__animated animate__fadeIn';
card.innerHTML = `
    <div class="user-card-header">
        <div class="user-card-avatar">
            ${initials}
        </div>
        <div class="user-card-name">${user.name}</div>
        <div class="user-card-role">
            <span class="role-badge ${roleClass}">${roleThai}</span>
        </div>
    </div>
    <div class="user-card-body">
        <div class="user-card-info">
            <div class="user-card-info-row">
                <div class="user-card-info-label">อีเมล:</div>
                <div class="user-card-info-value">${user.email}</div>
            </div>
            <div class="user-card-info-row">
                <div class="user-card-info-label">แผนก:</div>
                <div class="user-card-info-value">${deptName}</div>
            </div>
            <div class="user-card-info-row">
                <div class="user-card-info-label">สถานะ:</div>
                <div class="user-card-info-value">
                    <span class="status-badge ${statusClass}">${statusThai}</span>
                </div>
            </div>
        </div>
        <div class="user-card-actions">
            <button class="btn btn-sm btn-outline-primary" onclick="viewUser(${user.user_id})">
                <i class="fas fa-eye me-1"></i> ดู
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="openEditUserModal(${user.user_id})">
                <i class="fas fa-edit me-1"></i> แก้ไข
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteUser(${user.user_id})">
                <i class="fas fa-trash me-1"></i> ลบ
            </button>
        </div>
    </div>
`;

container.appendChild(card);
});
}

// กรองข้อมูลบุคลากร
function filterUsers() {
const searchText = document.getElementById('searchInput').value.toLowerCase();
const departmentId = document.getElementById('departmentFilter').value;
const role = document.getElementById('roleFilter').value;

// กรองข้อมูล
const filteredUsers = usersData.filter(user => {
// กรองตามข้อความค้นหา
const nameMatch = user.name.toLowerCase().includes(searchText);

// กรองตามแผนก
const deptMatch = !departmentId || user.dept_id == departmentId;

// กรองตามตำแหน่ง
const roleMatch = !role || user.role === role;

return nameMatch && deptMatch && roleMatch;
});

// แสดงผลลัพธ์
displayUsersTable(filteredUsers);
displayUsersCards(filteredUsers);
}

// เปิด Modal เพิ่มบุคลากรใหม่
function openAddUserModal() {
// ล้างค่าฟอร์ม
document.getElementById('userForm').reset();
document.getElementById('userId').value = '';
document.getElementById('passwordHelpText').style.display = 'none';

// เปลี่ยนชื่อ Modal
document.getElementById('userModalLabel').textContent = 'เพิ่มบุคลากรใหม่';

// แสดง Modal
userModal.show();
}

// เปิด Modal แก้ไขข้อมูลบุคลากร
async function openEditUserModal(userId) {
try {
// ดึงข้อมูลบุคลากรตาม ID
const response = await fetch(`${API_BASE_URL}/getUserById/${userId}`);
if (!response.ok) throw new Error('ไม่สามารถดึงข้อมูลบุคลากรได้');

const user = await response.json();

// กำหนดค่าให้ฟอร์ม
document.getElementById('userId').value = user.user_id;
document.getElementById('userName').value = user.name;
document.getElementById('userEmail').value = user.email;
document.getElementById('userRole').value = user.role;
document.getElementById('userDepartment').value = user.dept_id || '';
document.getElementById('userStatus').value = user.status;
document.getElementById('userPassword').value = ''; // ไม่แสดงรหัสผ่านเดิม
document.getElementById('passwordHelpText').style.display = 'block';

// เปลี่ยนชื่อ Modal
document.getElementById('userModalLabel').textContent = 'แก้ไขข้อมูลบุคลากร';

// แสดง Modal
userModal.show();
} catch (error) {
console.error('เกิดข้อผิดพลาดในการดึงข้อมูลบุคลากร:', error);
alert('ไม่สามารถดึงข้อมูลบุคลากรได้ กรุณาลองใหม่อีกครั้ง');
}
}

// ดูข้อมูลบุคลากร
async function viewUser(userId) {
try {
// ดึงข้อมูลบุคลากรตาม ID
const response = await fetch(`${API_BASE_URL}/getUserById/${userId}`);
if (!response.ok) throw new Error('ไม่สามารถดึงข้อมูลบุคลากรได้');

const user = await response.json();

// หาชื่อแผนก
const department = departmentsData.find(dept => dept.dept_id == user.dept_id);
const deptName = department ? department.dept_name : '-';

// แปลงตำแหน่งและสถานะเป็นภาษาไทย
let roleThai = 'ไม่ระบุ';

if (user.role === 'Doctor') {
    roleThai = 'แพทย์';
} else if (user.role === 'Nurse') {
    roleThai = 'พยาบาล';
} else if (user.role === 'Admin') {
    roleThai = 'ผู้ดูแลระบบ';
}

const statusThai = user.status ? 'ใช้งาน' : 'ปิดใช้งาน';
const statusBadge = user.status ? 
    '<span class="status-badge active">ใช้งาน</span>' : 
    '<span class="status-badge inactive">ปิดใช้งาน</span>';

// กำหนดค่าให้ Modal
document.getElementById('viewUserName').textContent = user.name;
document.getElementById('viewUserEmail').textContent = user.email;
document.getElementById('viewUserRole').textContent = roleThai;
document.getElementById('viewUserDepartment').textContent = deptName;
document.getElementById('viewUserStatus').innerHTML = statusBadge;
document.getElementById('viewUserId').value = user.user_id;

// แสดง Modal
viewUserModal.show();
} catch (error) {
console.error('เกิดข้อผิดพลาดในการดึงข้อมูลบุคลากร:', error);
alert('ไม่สามารถดึงข้อมูลบุคลากรได้ กรุณาลองใหม่อีกครั้ง');
}
}

// บันทึกข้อมูลบุคลากร (เพิ่มใหม่หรือแก้ไข)
async function saveUser() {
try {
// ดึงข้อมูลจากฟอร์ม
const userId = document.getElementById('userId').value;
const name = document.getElementById('userName').value;
const email = document.getElementById('userEmail').value;
const password = document.getElementById('userPassword').value;
const role = document.getElementById('userRole').value;
const deptId = document.getElementById('userDepartment').value;
const status = document.getElementById('userStatus').value;

// ตรวจสอบข้อมูล
if (!name || !email || !role) {
    alert('กรุณากรอกข้อมูลให้ครบถ้วน');
    return;
}

// สร้างข้อมูลสำหรับส่งไป API
const userData = {
    name: name,
    email: email,
    role: role,
    dept_id: deptId || null,
    status: status
};

// เพิ่มรหัสผ่านถ้ามีการกรอก
if (password) {
    userData.password = password;
}

// กำหนด API URL และ method ตามการเพิ่มหรือแก้ไข
let url, method;
if (userId) {
    // แก้ไขบุคลากร
    url = `${API_BASE_URL}/updateUser`;
    method = 'PUT';
    userData.user_id = userId;
} else {
    // เพิ่มบุคลากรใหม่
    url = `${API_BASE_URL}/addUser`;
    method = 'POST';
    
    // ตรวจสอบว่ามีรหัสผ่านหรือไม่
    if (!password) {
        alert('กรุณากรอกรหัสผ่าน');
        return;
    }
}

// ส่งข้อมูลไป API
const response = await fetch(url, {
    method: method,
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(userData)
});

if (!response.ok) throw new Error('ไม่สามารถบันทึกข้อมูลบุคลากรได้');

// ปิด Modal
userModal.hide();

// โหลดข้อมูลบุคลากรใหม่
loadUsers();

// แสดงข้อความสำเร็จ
alert(userId ? 'แก้ไขข้อมูลบุคลากรเรียบร้อย' : 'เพิ่มบุคลากรเรียบร้อย');
} catch (error) {
console.error('เกิดข้อผิดพลาดในการบันทึกข้อมูลบุคลากร:', error);
alert('ไม่สามารถบันทึกข้อมูลบุคลากรได้ กรุณาลองใหม่อีกครั้ง');
}
}

// ยืนยันการลบบุคลากร
function confirmDeleteUser(userId) {
document.getElementById('deleteUserId').value = userId;
deleteUserModal.show();
}

// ลบบุคลากร
async function deleteUser() {
try {
const userId = document.getElementById('deleteUserId').value;

if (!userId) {
    deleteUserModal.hide();
    return;
}

const response = await fetch(`${API_BASE_URL}/deleteUser/${userId}`, {
    method: 'DELETE'
});

if (!response.ok) throw new Error('ไม่สามารถลบบุคลากรได้');

// ปิด Modal
deleteUserModal.hide();

// โหลดข้อมูลบุคลากรใหม่
loadUsers();

// แสดงข้อความสำเร็จ
alert('ลบบุคลากรเรียบร้อย');
} catch (error) {
console.error('เกิดข้อผิดพลาดในการลบบุคลากร:', error);
alert('ไม่สามารถลบบุคลากรได้ กรุณาลองใหม่อีกครั้ง');
deleteUserModal.hide();
}
}

// อัพเดตจำนวนคำขอเปลี่ยนเวรที่รอดำเนินการ
async function updatePendingRequestsCount() {
try {
const response = await fetch(`${API_BASE_URL}/getRequests`);
if (!response.ok) throw new Error('ไม่สามารถโหลดข้อมูลคำขอได้');

const requests = await response.json();

// นับจำนวนคำขอที่มีสถานะ 'Pending'
const pendingCount = requests.filter(req => req.status === 'Pending').length;

// อัพเดต badge
const badge = document.getElementById('pendingRequestsCount');
badge.textContent = pendingCount;

// ซ่อน badge ถ้าไม่มีคำขอที่รอดำเนินการ
if (pendingCount === 0) {
    badge.style.display = 'none';
} else {
    badge.style.display = 'inline-block';
}
} catch (error) {
console.error('เกิดข้อผิดพลาดในการโหลดข้อมูลคำขอ:', error);
}
}
</script>
</body>

</html>